<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Control Modbus VFD</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 2px solid #007ACC;
            padding-bottom: 10px;
        }
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        button {
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-run { background-color: #28a745; color: white; }
        .btn-run:hover { background-color: #218838; }
        .btn-dir { background-color: #17a2b8; color: white; }
        .btn-dir:hover { background-color: #138496; }
        .btn-freq { background-color: #ffc107; color: black; }
        .btn-freq:hover { background-color: #e0a800; }
        
        .freq-control {
            display: flex;
            gap: 10px;
            align-items: center;
            grid-column: span 2;
        }
        
        input[type="number"] {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 5px;
            width: 100px;
        }
        
        .status {
            background-color: #f8f9fa;
            border-left: 4px solid #007ACC;
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 5px 5px 0;
        }
        
        .status h3 {
            margin-top: 0;
            color: #333;
        }
        
        .status-item {
            margin: 5px 0;
            font-family: monospace;
            font-size: 14px;
        }
        
        .state-run { color: #28a745; font-weight: bold; }
        .state-stop { color: #dc3545; font-weight: bold; }
        .dir-fwd { color: #17a2b8; }
        .dir-rev { color: #fd7e14; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Panel de Control Modbus VFD</h1>
        
        <div class="controls">
            <button class="btn-run" onclick="toggleRun()">üîÑ RUN/STOP</button>
            <button class="btn-dir" onclick="toggleDir()">‚ÜîÔ∏è FWD/REV</button>
            
            <div class="freq-control">
                <input id="freq" type="number" placeholder="Hz" min="0" max="60" step="0.1">
                <button class="btn-freq" onclick="setFreq()">‚ö° Set Frequency</button>
            </div>
        </div>

        <div class="status">
            <h3>üìä Estado Actual</h3>
            <div id="status-content">
                <div class="status-item">üîÑ Estado: <span id="state">---</span></div>
                <div class="status-item">‚ÜîÔ∏è Direcci√≥n: <span id="direction">---</span></div>
                <div class="status-item">‚ö° Frecuencia: <span id="frequency">---</span> Hz</div>
                <div class="status-item">üì° √öltima actualizaci√≥n: <span id="last-update">---</span></div>
            </div>
        </div>
    </div>

    <script>
        async function toggleRun() {
            try {
                const response = await fetch('/api/run', {method: 'POST'});
                const result = await response.json();
                console.log('RUN/STOP:', result);
                refresh();
            } catch (error) {
                console.error('Error toggling run state:', error);
                alert('Error al cambiar estado RUN/STOP');
            }
        }

        async function toggleDir() {
            try {
                const response = await fetch('/api/dir', {method: 'POST'});
                const result = await response.json();
                console.log('FWD/REV:', result);
                refresh();
            } catch (error) {
                console.error('Error toggling direction:', error);
                alert('Error al cambiar direcci√≥n');
            }
        }

        async function setFreq() {
            const freqInput = document.getElementById('freq');
            const freq = parseFloat(freqInput.value);
            
            if (isNaN(freq) || freq < 0 || freq > 60) {
                alert('Por favor ingresa una frecuencia v√°lida (0-60 Hz)');
                return;
            }

            try {
                const response = await fetch('/api/freq', {
                    method: 'POST',
                    body: `freq=${freq}`,
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'}
                });
                
                const result = await response.json();
                
                if (result.status === 'ok') {
                    console.log('Frequency set:', result);
                    freqInput.value = ''; // Clear input
                } else {
                    alert('Error: ' + result.message);
                }
                refresh();
            } catch (error) {
                console.error('Error setting frequency:', error);
                alert('Error al establecer frecuencia');
            }
        }

        async function refresh() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                // Update status display
                const stateElement = document.getElementById('state');
                const directionElement = document.getElementById('direction');
                const frequencyElement = document.getElementById('frequency');
                const lastUpdateElement = document.getElementById('last-update');
                
                // Set state with appropriate styling
                stateElement.textContent = status.state || 'UNKNOWN';
                stateElement.className = status.running === 'true' ? 'state-run' : 'state-stop';
                
                // Set direction with appropriate styling
                directionElement.textContent = status.direction || 'UNKNOWN';
                directionElement.className = status.direction === 'FWD' ? 'dir-fwd' : 'dir-rev';
                
                // Set frequency
                frequencyElement.textContent = status.frequency || 0;
                
                // Set last update time
                lastUpdateElement.textContent = new Date().toLocaleTimeString();
                
                console.log('Status updated:', status);
            } catch (error) {
                console.error('Error fetching status:', error);
                document.getElementById('state').textContent = 'ERROR';
                document.getElementById('direction').textContent = 'ERROR';
                document.getElementById('frequency').textContent = 'ERROR';
            }
        }

        // Initialize
        refresh();
        
        // Auto-refresh every 2 seconds
        setInterval(refresh, 1000);
        
        // Allow setting frequency with Enter key
        document.getElementById('freq').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                setFreq();
            }
        });
    </script>
</body>
</html>