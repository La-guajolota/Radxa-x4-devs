# Makefile for Modbus RTU example as a client
# Author: AdriÃ¡n Silva Palafox

# Compiler variables
CC = gcc
CFLAGS = -Wall -Wextra -std=gnu99 -D_GNU_SOURCE -I/usr/include/modbus
LIBS = -lmodbus -lpthread
TARGET = modbus_rtu
SOURCES = main.c

# Directory variables
SRCDIR = .
BUILDDIR = build

# Object files
OBJECTS = $(SOURCES:%.c=$(BUILDDIR)/%.o)

# Default rule
all: $(TARGET)

# Create build directory if it doesn't exist
$(BUILDDIR):
	mkdir -p $(BUILDDIR)

# Build main executable
$(TARGET): $(BUILDDIR) $(OBJECTS)
	$(CC) $(OBJECTS) -o $(TARGET) $(LIBS)
	@echo "âœ… Build successful: $(TARGET)"

# Compile object files
$(BUILDDIR)/%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# Clean generated files
clean:
	rm -rf $(BUILDDIR)
	rm -f $(TARGET)
	@echo "ðŸ§¹ Build files removed"

# Install dependencies (Ubuntu/Debian)
install-deps:
	sudo apt update
	sudo apt install -y libmodbus-dev libncurses-dev build-essential
	@echo "ðŸ“¦ Dependencies installed"

# Run the server
run: $(TARGET)
	./$(TARGET)

# Run in debug mode (without real Modbus)
run-debug: $(TARGET)
	@echo "ðŸ› Running in DEBUG mode"
	./$(TARGET)

# Check dependencies
check-deps:
	@echo "ðŸ” Checking dependencies..."
	@pkg-config --exists libmodbus && echo "âœ… libmodbus found" || echo "âŒ libmodbus NOT found"

# Optimized build for production
release: CFLAGS += -O2 -DNDEBUG
release: $(TARGET)
	@echo "ðŸš€ Built for production"

# Show help
help:
	@echo "ðŸ“– Available commands:"
	@echo "  make              - Build the project"
	@echo "  make clean        - Clean build files"
	@echo "  make install-deps - Install system dependencies"
	@echo "  make run          - Build and run"
	@echo "  make run-debug    - Run in debug mode"
	@echo "  make debug        - Build with debug symbols"
	@echo "  make release      - Build optimized"
	@echo "  make check-deps   - Check dependencies"
	@echo "  make help         - Show this help"

# Avoid conflicts with files of the same name
.PHONY: all clean install-deps run run-debug check-deps debug release help